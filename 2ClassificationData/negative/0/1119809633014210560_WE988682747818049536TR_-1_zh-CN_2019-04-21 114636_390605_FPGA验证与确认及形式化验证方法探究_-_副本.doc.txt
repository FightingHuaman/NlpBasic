FPGA验证与确认及形式化验证方法探究

摘要：近年来，FPGA技术发展日趋成熟，随之而来的是FPGA开发过程中的验证问题，在实际的验证与确认过程中，由于开发过程自上而下，经历综合优化的FPGA电路可能存在优化前后电路功能的不一致的问题，常规的仿真测试方法等很有可能难以发现其中的错误，并且不能证明没有引入错误，给验证过程带来困难。因此，如何验证综合前后电路的等效性成为FPGA验证与确认的重要组成部分，通过引入形式化验证方法可以进行电路等价性验证，能较好地解决这一问题，可作为FPGA验证方法的有效补充。
关键词：FPGA开发；验证与确认；仿真测试；形式化验证
0 引言
FPGA（现场可编程门阵列）是核工业中的新兴技术，因为其高可靠性、高速度、简化设计、降低系统复杂性等方面的优势被逐步应用于核电站安全级数字化控制系统[2]，为了满足速度，集成和灵活性的要求，FPGA已成为信号处理系统，控制系统和其他数字系统不可或缺的核心单元，但同时由于核电站对系统高可靠性的要求，会在平台及应用软件的开发过程中，进行严格的验证与确认工作，相对于常规软件，FPGA具有软件与硬件的共同特性，使得在核电站中的应用时会面临难以验证其安全性和可靠性的挑战。
验证人员需要在完成硬件描述语言的代码编写后验证代码设计和要求的正确性，验证工作越完善，越早出现缺陷，避免设计后期的问题积累和被动补偿，有利于加快设计进度，提高可靠性。随着电子设计自动化技术的不断发展，开发工具日渐强大，日益流行的IP核的使用和嵌入式CPU的应用，使用的FPGA芯片规模正呈现指数式上升，导致功能性验证变得越来越复杂。当设计集成度突破百万门级之后，验证所需要花费的时间和难度远远超过设计本身，而在这种复杂情况下，经过综合前后的电路出现问题的可能性也会随之增大，这给验证综合前后电路的等价性问题带来严峻挑战，因此在对FPGA开发的验证与确认过程中，需要不断研究相关测试理论及验证技术，以提高验证与确认效率和质量，达到开发高可靠性产品的目的。本文从FPGA特点入手，梳理FPGA验证与确认过程，结合形式化验证方法中的等价性验证对综合前后的电路进行等价性验证，完善了验证与确认过程。
1 FPGA特点 
FPGA技术可以追溯到20世纪90年代中期，作为微处理器的替代品，可用于替代可编程逻辑器件（PLD）和具有特定功能的集成电路。FPGA是可根据需要进行编程或重新编程的半导体器件。通过FPGA技术实现安全级数字化系统可以带来非常多的优点。
首先，采用FPGA开发的系统可以在无需操作任何软件的情况下实现安全功能，甚至不需要操作系统的支持，系统得到极大简化，降低了复杂程度，透明和简单的设计，让开发和验证与确认活动效率提升，并且让系统在网络安全方面具有独特优势，目前为止，还没有已知的HDL病毒和恶意软件；其次，其内部电路并行执行的特性使得系统响应时间得到提升，相比于顺序执行指令集的微处理器，其控制算法和通信功能更加迅速地实现；另外，不同厂商生产的FPGA芯片之间HDL代码的可移植性，让芯片的更新移植变得简便，甚至可以重复使用；最后，HDL代码位于不需要物理访问的闪存中，用于在线模式下的修改， FPGA编程和重新编程只能通过特殊接口完成，无法连接到可能感染控制逻辑代码的公共存储介质或通信设备。
FPGA是一个复杂的可编程组件，由PFGA芯片和FPGA电路设计两个实体组成， FPGA芯片是硬件的一部分，应满足硬件质量测试要求，FPGA电路设计由硬件描述语言实现，应根据功能要求进行验证。在FPGA的基本开发过程中，在布局和布线过程之后，它可以被视为一个完整的硬件系统，与微处理器不同，预设功能通过电路并行实现，而不是顺序读取和执行指令；“布局和布线”之前的工作是通过EDA软件设计工具完成的软件开发过程，FPGA应该被视为一个软件系统。
2 FPGA验证与确认
虽然FPGA在技术上有很大的优势，已在其他领域已经得到了广泛的应用，但核电领域的表现则相对较弱，目前相关的标准规范正在变得更加完善，针对核电的安全演示方法已经明确形成。可用于指导方法在核安全级仪器控制系统中的应用，包括原理图验证，开发工具验证，核心IP验证和大规模试验等。
由于FPGA应用在设计的所有阶段都可能存在错误，因此，设计必须经过验证与确认流程。验证与确认的目的是表明设计各阶段的产品满足其需求并满足其预期用途和目的。验证是设计阶段的产品确定先前设计阶段要求的过程。是确定整个设计过程中的产品是否正确以及是否有意实现其目标的过程。如前所述，放置和布线之前的FPGA芯片开发活动类似于软件开发活动，每个活动都使用软件工具将产品或应用系统要求转换为目标语言实现代码。验证与确认活动应与所有开发活动同时进行，符合与核控制系统类似的直接开发过程，包括概念、需求、设计、实现、测试等阶段。开发过程的所有活动。输出与其输入一致，以验证最终产品是否满足其要求。
与软件相比，FPGA验证要求更复杂，所使用的验证技术和方法也不同。为确保符合核安全监管要求，需要100％的项目测试目标。FPGA自顶向下的设计方法一般可分为系统级，行为级，RTL级，门级和布局级。需要验证系统级和行为级描述是否与设计一致。这是一种设计验证。当功能在行为级别，RTL级别，逻辑门级别和布局级别之间保持一致时，实现验证。
通常通过综合工具实现不同的转换水平。将RTL描述转换为门级描述的逻辑综合工具的应用通常分为三个步骤：首先，将RTL描述转换为未优化的门级布尔描述，例如逻辑门、触发器、寄存器等; 然后通过执行优化算法获得优化的布尔描述; 最后，根据目标过程要求将优化的布尔描述映射到实际的逻辑门。由于合成算法和集成过程本身的复杂性，可能将错误引入该过程。传统的测试方法，如RTL仿真测试方法，可能很难发现错误，或者无法证明没有错误，这使得FPGA验证过程变得困难。因此，针对模拟验证的一些缺点，引入了形式验证方法，作为FPGA验证方法的有效补充。
3 形式化验证方法
形式化验证是基于数学来验证不同的设计阶段。形式化验证需要系统模型，特殊工具和技能，以及可与设计特征进行比较的适当形式要求。形式化验证使用数学方法来表达系统的规范和性质。根据数学理论证明设计的系统满足规范并具有期望的性能。其方法可以分为两部分：等价性验证和性质检查。其中性质验证包括定理证明和模型检验。
从FPGA开发过程中，我们可以知道电路设计是自上而下的，从行为级到RTL级，再到逻辑门级，最后到布局级。在集成过程中，有优化的电路，为了确保优化前后的电路功能的一致性，则要求进行电路的等效效验证。在FPGA验证和验证过程中，使用属性验证来确保设计原型的正确性。上述RTL级别，门级和布局级别以及其他基础设计之间的验证可以通过等效来验证，以确保设计原型和设计实现之间的一致性。
FPGA验证对形式化验证过程实质上是组合电路的等效性验证，即在任何可能的输入条件下，电路的输出是否一致。通常等效性验证可以通过基于输入空间构造简化有序二元决策图（ROBDD），并通过ROBDD的比较来确定输出状态的等价，但是这种基于输入空间构造二元决策树的方法难以直接应用于大规模复杂电路，作为FPGA，即使将验证电路分成小规模电路以进行验证也是耗时耗力，效率低下。
另一种方法则是将待验证的组合电路组合成一个大的Miter电路，电路构造如图1所示。

图1  Miter电路构造
在此理论基础上，通过构建可满足性（SAT）求解器验证组合电路的等效性。具体过程是在优化之前和之后组合FPGA合成过程的输入端，并且每对经过电路所产生的相应输出进行异或处理，即存在不同输出时，此组信号输出为1。每一组异或处理的输出结果都连接到或门，在进行或操作之后输出最终信号。在给定约束输入的情况下，通过程序记录最终信号的变化情况，如果最终输出恒为0，说明相同输入时，不存在输出不同的情况，那么电路是等效的。如果存在输出为1，即存在相同输入时，输出不同的情况，则两个电路不相等。这种形式化验证方法充分体现电路输入输出特点，提高了等价性验证的验证效率。
4 结语
核电站安全级DCS中运行的软件必须进行完整严格的验证与确认活动，在含有FPGA的系统中，需要根据FPGA的特点与开发过程，针对硬件描述语言代码综合前后可能由于综合软件的优化导致的等效性问题进行深入思考。基于此，通过分析传统FPGA仿真验证过程的基础上，提出结合形式化验证方法和通用验证方法，进行安全级DCS系统FPGA产品的验证与确认，达到了验证综合前后电路的等价性目的，后续将根据此原理提出一种高效且可重用的FPGA综合前后等价性验证平台。可用于快速有效地完成FPGA的综合前后电路的等价性验证，作为FPGA验证方法的有效补充，以更好地完成系统的验证与确认活动，提高产品的可靠性。

