题目：“云养老”－基于云平台的老人监护系统架构与实现

摘要：（400左右）
为了满足逐步进入老龄化社会的中国日益增长的老人监护需求，本文设计并实现了一个基于云平台的老人监护系统框架。基于云技术，采用多平台结合的方式，方便用户采用多样化的沟通渠道，实现对老人的实时监护；为了承载密集的用户访问量，系统采用了多种并发控制策略，保证系统的运行稳定性和实时响应速度。系统由五个核心功能模块组成，其中在实时定位模块中采用的多种定位技术和在电子围栏模块中提出的区域包围算法，能够帮助子女远程监护和指导老人，实时准确地了解老人最新的详情；提醒服务模块和预警服务模块提供的高效信息传递服务和快速更新设置，可以及时提醒子女为老人准备好每一天的生活。在系统投入实际应用一年的时间内，平稳的运行状况、良好的用户体验和快速的响应速度，使其获得了良好的用户口碑，并在帮助子女监护老人方面发挥重要作用。
1. 引言
在首届中国国际养老服务业博览会在沪开幕，以物联网技术应用为基础，“云养老”的概念浮出水面，成为博览会上的一大亮点。“云养老”其实就是基于云计算商业模式应用的，为居家养老和社区养老服务中心提供成熟可靠的信息化手段的服务和管理。
然而在国外，云养老平台已经比较成熟，比如日本电气股份有限公司2010年就已经在澳大利亚开设的Aged Care Cloud Solutions服务就比较成熟了，Aged Care specific software applications and communication solutions hosted in the cloud、Next generation biometric solutions for movement, fall and wandering detection等云服务的推出，使得这种养老模式逐渐被当地居民所接受[1]。此外，富士通2013也在日本东京试水Cloud Service for Senior Care项目，也是为老人提供一些需要的生活服务和医疗服务[2],由此可见，云养老的需求是很大的。
而在国内，关于养老这方面也已经有不少人提出过解决方案，比如有研究人员设计一个云平台，可以安装运行应用，these applications built based on the proposed system better satisfy the real demands from the medical professionals and caregivers[3].但是一些系统由于终端设备价格过高，需要各种传感器去实现，导致这个养老成本急剧上涨,子女无力承担高昂的消费[4-5]，另一些系统由于支持的平台较少，不能满足所有人的需求，使用范围就被大大限制了[6]。
在养老矛盾重重和“云养老”未很好落地的双重背景之下，我们和长兴县政府和联通公司进行三方合作，根据一下已有的研究[7]提出了一种衍生于物联网的社区式信息化养老解决方案。不同于传统的社区服务、家庭养老的方式，乐智云养老平台充分考虑到空巢老人和其子女的需求，实现对老人日常活动的全方位服务，设立紧急救援机制，打破子女只能通过电话了解父母近况的单一模式和没有针对老人的有效救援机制的现状。社区式信息化养老可以大量节省人力、物力资源，不仅可以直接减轻子女养老负担，还可以更加全面地关怀老人，给老人足够的精神慰藉。
2. 系统总览
本平台为用户提供了一个智慧关怀平台，为老人提供各种生活服务以及为子女提供关于老人的预警服务。整个平台包括预警服务模块，提醒服务模块，GPS/GSM实时定位模块，电子围栏模块，一键拨号设定模块。多平台之间采用JSON数据传送。平台开发环境采用Microsoft Windows 7，开发工具采用eclipse，用Java开发的，以及系统架构采用Spring + Struts + Mybatis结构，其中信息的存储和管理采用Mysql数据库，接口采用RESTFUL风格，统一使用JSON串的形式传递数据。下面从系统架构和模块联系两方面来介绍这个系统设计。
2.1系统架构：
本系统整体架构可以分为数据采集平台、查询平台和服务器平台，android平台、IOS平台、功能机平台能用于数据的采集工作比如采集一些位置信息、温度信息、预警信息等上传到服务器中，服务器对于不同的事件做出不同的响应与处理，比如服务器端接收了到了预警信息，那么就会开启处理预案，通知监护人和呼叫中心人员，立即介入事件的处理，同时将这条信息存入数据库中，以备后查，除此之外的网页平台和微信公共平台主要用于后期的数据查询，当然android和IOS平台也是支持数据查询的，这样就能做到随时随地能了解最新的消息。

图1  系统架构图

2.2模块联系：
移动设备采集到各种数据，比如定位信息、各种预警信息，通过服务器的数据采集接口，将采集到的数据进行相应的处理，如果一些位置信息经过电子围栏模块的检测到越界，或者收到一些预警信息，那么会将相应的信息下发到监护人的手机中，提醒监护人。具体各个模块之间的联系如下图所示。

图2 功能模块图
3. 系统架构策略
	为了满足不同人群的使用需求，本系统加入了多个平台的支持，做到了尽量满足所有人的需求，使得使用起来更加地便捷。这里使用了5种不同的平台，用于和服务器进行数据的交互，但是不同的平台之间的数据组织结构是不同的，为了不同平台之间的数据交互，需要在接收到不同平台发送来的数据后立即进行数据的格式化，方便数据的使用。
3.1 多平台集成方式
根据设计需要，整个系统分为服务器平台和移动平台，分别进行数据采集和数据处理，同时所有的平台都支持实时查看最新的数据。
（1）服务器平台包括网络接口服务。
服务器中核心的部件是网络接口服务，它是为了使原来各孤立的站点之间的信息能够相互通信、共享而提出的一种接口。所使用的是Internet上统一、开放的标准，本系统采用HTTP协议进行不同平台之间进行数据交换，可以在任何支持这些标准的环境中使用。
（2）移动平台包括ANDROID，IOS，功能机。
移动平台采用C/S 结构访问服务器。C/S 结构是软件系统体系结构，通过它可以充分利用两端硬件环境的优势，将任务合理分配到Client端和Server端来实现，降低了系统的通讯开销。
网络接口服务和移动平台的数据交互如下：

图3 移动平台与服务器交互图
从上面的图中可以看出：移动端将数据发送给服务器，之后进行相应的处理，将结果存入数据库中，遇到预警信息等需要第三方介入时，则同时会将相应的消息传送给其他的模块继续处理。
（3）信息查询平台：WEB、微信端、ANDROID和IOS平台
	所有采集到的数据都能在后期通过查询的方式获得全部的信息，包括所有的预警信息和位置的历史轨迹，都能很方便地查看到。

图4 信息查询流程
3.2 并发控制策略
所有的平台的数据都会通过数据流的方式与服务器进行频繁的数据交互，当所有的设备同时访问数据库，对于平台的要求是非常高的，需要承载较大的并发量,我们采取了下列并发控制策略：
（1）使用Nginx代理服务器架在浏览器和web服务器之间，Nginx是一款高性能的HTTP和反向代理服务器，能够选择高效的epoll(linux2.6内核)、kqueue(freebsd)、eventport(solaris10)作为网络I/O模型，能够支持高达50000个并发连接数的响应，而内存、CPU等系统资源消耗却非常低、运行非常稳定。
（2）HTML静态化，效率最高、消耗最小的就是纯静态化的html页面，所以我们尽可能使我们的网站上的页面采用静态页面来实现，这个最简单的方法其实也是最有效的方法。
（3）Ehcache缓存技术：Ehcache是一个快速的、轻量级的、易于使用的、进程内的缓存。它支持read-only和read/write缓存，内存和磁盘缓存。但是在开发的时候发现了一个缺点就是无法对于多块数据单元进行一个有效的管理，并且在数据过期的时候无法提供有效的更新机制，所以这里写了一个数据缓存池来满足这个需求。

图5 Ehcache缓存块的管理示意图

从上面的Cache管理图中可以看出：数据缓冲池会负责数据获取和数据更新，当数据过期的时候，直接返回数据单元并且触发实体内的更新器，使得数据缓存效率最高。使用对象锁的方式来进行数据过期的并发控制，因为这里大部分都是内存的运算操作，所以速度较快。
（4）负载均衡：本系统使用了两台服务器以对称的方式组成一个服务器集合，两台服务器都具有等价的地位，都可以单独对外提供服务而无须另一台服务器的辅助。通过负载分担技术，将外部发送来的请求均匀分配到对称结构中的某台服务器上，而接收到该请求的人服务器独立地回应客户的请求。均衡负载能够平均地分配客户请求到服务器阵列，籍此提供快速获取重要数据，解决大量并发访问服务问题。这种群集技术可以用最少的投资获得接近于大型主机的性能。

4 功能模块设计
根据系统架构设计，按功能进行划分，包含预警服务模块、提醒服务模块、GPS/GSM实时定位模块、电子围栏模块和一键拨号设定模块。下面详细介绍每个模块的功能以及为了实现所要求的功能而采取的技术策略。
4.1 预警服务模块
预警服务模块包括静默预警，跌倒预警，SOS预警和温度异常预警四种方式。
（1） 静默预警是为了预防出现老人白天出现意外长时间不动出现意外而设置的预警。这个子模块主要采用三轴陀螺仪三个参量和GPS参数的解决方案，将采集到的数据进行计算：
轴向偏移量 E=Ex2+Ey2+Ez2  
经纬度偏移量 D=(∆lat)2+(∆lng)2
其中Ex、Ey、Ez表示在X轴、Y轴、Z轴 方向上的轴偏移参数。∆lat，∆lng分别表示一段时间内经度和纬度的变化，综合这两个参数，如果E（0.2）于一个阀值或D大于一个阀值（0.00001）则判为运动，长时间不运动则预警。
（2） 跌倒预警是防止老人出现意外摔倒，进行预警。这个子模块主要采用加速度传感器中三个轴向的加速度，进行如下的运算：
加速度偏移量  a=ax2+ay2+az2
其中ax、ay、az表示在X轴、Y轴、Z轴方向上的偏移参数。如果a大于一定的阀值(0.90)可认为出现了摔倒情况。
（3）SOS预警是老人求救使用。接入语音呼叫中心，为老人及时解决难题。因为老人在按下SOS键时是处于危险状态，他可能没有办法提供自己当前的准确位置，为了解决这个问题，系统会通过短信下发一条指令，使手机进行2个小时的长连接，做到实时上载最新的位置，以便快速定位老人的位置，同时服务平台会同时提醒监护人去关心老人的情况。

图6  SOS服务流程图
（4）温度异常预警，这个子模块采用外部设备，来测量当时的温度，如果温度高于一个阀值或低于一个阀值，则被判定为老人出现意外，及时预警。这个服务还能用于天气预报高温或者低温预警，平台会定时获取最新的天气情况，及时地提醒老人和监护人做好防护。由于数据量较大，采用预先获取各地区天气的解决方案，加快效率。
4.2 提醒服务模块
提醒服务模块包括循环提醒，一次性提醒，按周/月提醒。将提醒分成三种类型，能满足不同的需求，比如循环提醒能提醒老人及时按时地吃药或者定期做健康检查，子女也能通过一次性提醒及时提醒老人做一些事情。不过由此产生了一个问题，当提醒发送器在频繁查询数据库时，这个效率就比较低了，不但每次都需要查询这三张不同的表，还需要查询这三张表中全部的记录，包括那些已经发送过了的提醒。需要解决这个问题，那么添加了一个预查询和另存储的机制，也就是说，在凌晨服务器比较空闲的时段先将今天需要发送的短信提取到一张临时的数据表中，为了需要和原来表中的数据对应起来，需要额外添加一个字段用于识别是什么类型的提醒消息。临时表与三张原表之间的关系示意图如下： 
定义:Type{一次性提醒,循环提醒,周/月提醒}

图7 临时表与原表的联系图
根据新设计的一张临时表中的Type值来区别到底是哪种提醒信息，这样在修改原表中记录的同时还能对应地来修改这样预发送的临时表。每次只要查询这张临时表即可，至于当天出现的提醒修改，判断是今日的需要发送的提醒，那么需要修改这张临时表。
上面的机制通过一个较小的代价能在之后的系统运行状态中大大地提高效率。这个提高的效率可以根据如下公式进行计算：
η=3*i=13mii=13ni*k
其中的mi代表一张原来表中所有记录条数，ni代表一张原来表中当天需要发送的记录条数，k代表当天提醒发送器运行的次数，而如果使用原方案则每次需要查询三张表，而使用新方案每次只需要查询一张表，效率η提高了三倍，根据这个公式可知，每天的发送量i=13ni总是会处在一个区间中，而这三张原表中的记录总数i=13mi每天都会不断变大，那么长此以往，这个系统的响应速度也会越来越慢，而每次重复k次操作，使得这个提高的效率线性增长。

4.3 GPS/GSM实时定位模块
GPS/GSM实时定位模块采用了全球定位系统技术，实时定位老人的位置，子女能及时掌握老人的行踪，在紧急关头还能快速定位。由于GPS在室内有时不能定位，所以采用了GSM/WIFI定位的方式，做到定位的无缝衔接，实时定位。为了提高室内定位到精度，这个系统使用了加速度传感器来预测手机在室内的移动情况。
算法如下：
Step1：由于高斯白噪声和脉冲噪声会使加速度计产生误差，也就是说加速度计采集信号过程中，经常会受到工作环境以及硬件自身的干扰，实际采集到的加速度数据与真实值之间有一定的偏差。那么本系统采用去掉最大值，去掉最小值，计算剩余的平均值：
avg= i=1nain-2（i≠k1, i≠k2）
其中ai是在i时刻所测的瞬时加速度，i=k1时ai取得最大值，i=k2时ai取得最小值。
Step2： 加速度计信号经过滤波后，分别是对加速度的积分和对速度的积分
vt1=t0t1a1dt   st1=t0t1v1dt
其中vt1是在t1时刻的速度，st1是在t0-t1时刻所产生的位移偏移量。上式中积得v1=v0+a1*∆t ，其中的v0使用在最后时刻GPS测得的速度v。上式中积得s1=s0+v1*∆t ，由于每次都是测得加速度数据后直接计算距离了，那这个s0取值为零。
Step3：以上的算法只计算了一个方向上的偏移值，另两个方向的算法和这个类似，每次都将计算之后的都更新到预测的位置参数中，用于位置的上载。
在服务器端接收数据显示在网页或者移动端时，直接使用GPS真实数值显示在地图上会出现错误，因为在地图上显示的数据需要使用SM模组加偏，其实就是对真实坐标系统进行人为地加偏处理，按照几行代码的算法，将真实的坐标加密成虚假的坐标，而这个加偏并不是线性的加偏，所以各地的偏移情况都会有所不同。而加密后的坐标也常被人称为火星坐标系统，所以如果我们直接使用在手机中直接测得的真实坐标系统在地图上显示，那么就会出现误差，需要使用加偏算法之后才能显示。
4.4 电子围栏模块
老人走失事件时有发生，老人在外出途中迷路，偏离了回家的方向，最终导致老人走失，因此电子围栏模块能很好地预防老人迷路等情况，走到了较远的地方，能及时预警。子女会预先设定一个范围，如果老人的位置超出了这个范围，那么就会预警。因此需要一个算法来判断老人是否位于这个设置的范围之内。
Define：存储这个范围采用一串有顺序的点的方式，按照点的顺序围成一个封闭的图形，其中顺时针和逆时针绘制的封闭图形都可行，如果围成的封闭图形有重叠的部分，那么我们规定这个重叠部分不属于这个封闭图形内。
经过仔细的考虑，判断点在一个封闭图形内，可以分为以下5种情况来讨论，这5种情况的示意图如下： 
 (a)  (b) (c)
    (d)(e)
图8 点与封闭图形的分类图
(1) 第一种情况：如图8（a）显示了一个具有14条边的凹封闭图形。我们要判断红色点是否在封闭图形内。解决方案是将测试点的Y坐标与封闭图形的每一个点进行比较，我们会得到一个测试点所在的行与封闭图形边的交点的列表。在这个例子中有8条边与测试点所在的行相交，而有6条边没有相交。如果测试点的两边点的个数都是奇数则该测试点在封闭图形内，否则在封闭图形外。在这个例子中测试点的左边有3个交点，右边有5个交点，它们都是奇数，所以点在封闭图形内。
(2) 第二种情况：如图8（b）显示了封闭图形自交的情况。在这个例子中封闭图形有10条边，其中有些互相交叉。这种情况很像汇编语言中的“异或”（XOR）。封闭图形中重叠的部分剔除。因此测试点在封闭图形的外面，我们从它的左右两边各有两个交点也可以看出来。
(3) 第三种情况：如图8（c）中封闭图形没有重叠，但是有两条边相交。这种情况下算法也没有问题，仍然可以正常工作。
(4) 第四种情况：如图8（d）显示了当我们要测试的点所在的扫描行正好穿过封闭图形的一个顶点，因此扫描行与边a有一个交点，与边b也有一个交点，一共有两个交点，测试点的右边也是同样的情况，那按照我们的算法得到：测试点在封闭图形外的结论，但这显然是错误的！要解决这种情况遇到的问题非常简单。边上的点是否与扫描行相交，我们要看边的两个端点是否是在扫描行的两侧，在扫描行上或上方的端点我们把它认为是同一种情况，那图8（d）中边a的一个端点在扫描线的下方，另一个点在扫描线上或上方，所以边a与扫描线相交，而边b的两个端点都在扫描线上或上方，所以边b与扫描线不相交。
(5) 第五种情况：如图8（e）显示的封闭图形上的一条边完全与扫描行重合的情况。根据第四种情况具体描述的：边c的一个端点在扫描线的下方另一个端点在扫描线上或上方，所以边c与扫描线有一个交点，而边d的两个端点都在扫描线上或以上，所以无交点，边e也是两个端点都在扫描线上或以上，所以也没交点。
综合上述情况所得的算法，可以得到一个算法去判断老人是否越界的问题。
4.5 一键拨号设定模块
这个模块用于更新移动端的快捷键设置，有时候我们会遇到相关联系人的手机号可能更改了，而老人又不会手动修改联系人信息，那么就可以通过这个，允许监护人为老人更新快捷键的设置信息。
由于是线上更新，需要将这个设置信息下发到移动设备端，这里需要考虑省流量和实时性之间的平衡，所以本系统提供了两种解决方案，用户可以根据自己的情况选取其中的一种模式，默认省流量优先：方案一是省流量优先，这种方案是在上载位置信息的时候会将更新的数据同时下载到手机上，这种方式不需要频繁地访问服务器，节省流量，不过实时性不高。方案二是实时性优先，如果用户对实时更新特别需要，那么可以设置成这种模式，这种状态下，移动设备端与服务器保持TCP长连接，当监护人在更新了快捷键设置，服务器会马上将这个设置信息下发到移动端，做到真正的实时性。
在上述几个模块之外，系统还提供了短信传送功能，为预警服务模块、提醒服务模块、电子围栏模块服务，用于将预警信息和越界信息下发到子女手机上，将提醒信息下发到老人手机上。准备发送的短信会被放入一个临时表中，发送之后会有相应的发送记录。

5. 系统测试与应用:
基于上述架构，我们与中国联通和浙江省湖州市长兴县政府合作开发了一个实用的基于云平台的老人监护系统－“云养老”，并对其进行了全面的性能和功能测试。测试环境是IBM x3650 M4（CPU:双核/RAM:4GB）两台服务器阵列，网络采用6M光纤，操作系统是 Windows server 2008。测试从三个方面进行：负载测试结果网站同时用户人数能达到2000以上，而压力测试结果显示并发量能达到10000以上，下图是根据测试后所得到的并发数与响应速度的曲线图：

图8 并发数与响应时间的曲线图

截止目前，本系统已经在浙江省湖州市长兴县民政部门试运行一年，运行平稳且没有出现过服务器奔溃状态。良好的用户体验和快速的响应速度，使得本系统获得了良好的用户口碑，并在帮助子女防止老人发生不必要的伤害方面起到重要作用。

参考文献：
[1] http://au.nec.com/en_AU/solutions/specialist-solutions/
solution-design-development/aged-care-cloud-solutions-overview.html
[2] http://www.fujitsu.com/global/news/pr/archives/month/2013/
20130123-01.html
[3] Yu-Chiao Huang: An Extensible Situation-Aware Caring System for Real-World Smart Wards(2012)
[4] Qingying Zhang:Internet of Things Applied in the Home-Based Caring System for the Aged(2012)
[5] 曹琦:基于ZigBee的社区居家养老系统的研究(2011)
[6] 王鑫:用于智慧养老系统的ban网关系统的研究与开发(2012)
[7] 朱顺兵、邹万流: 智能化养老系统建设研究(2013年第8期总第201期)
